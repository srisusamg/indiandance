<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>🎮 Bollywood Beat Master - Dance Gaming Experience �</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;600;700&family=Fredoka+One:wght@400&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Dancing Script', cursive;
            background: linear-gradient(45deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3, #54a0ff);
            background-size: 300% 300%;
            animation: bollywoodGradient 4s ease infinite;
            overflow: hidden;
            height: 100vh;
            height: 100dvh; /* Dynamic viewport height for mobile */
            user-select: none;
            touch-action: manipulation;
            position: relative;
            /* Mobile Safari bottom bar fix */
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .theme-holi { background: linear-gradient(45deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3, #54a0ff); }
        .theme-diwali { background: linear-gradient(45deg, #ff9500, #ff6b00, #ffdd00, #ff4757, #ffa502); }
        .theme-wedding { background: linear-gradient(45deg, #ff6b9d, #c44569, #f8b500, #ff6348, #ff9ff3); }
        .theme-club { background: linear-gradient(45deg, #1e3c72, #2a5298, #ff6b6b, #feca57, #ee5a24); }
        
        @keyframes bollywoodGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .disco-lights {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .disco-ball {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: radial-gradient(circle, silver, gray);
            animation: discoBallSpin 3s linear infinite;
            z-index: 5;
        }
        
        @keyframes discoBallSpin {
            0% { transform: translateX(-50%) rotate(0deg); }
            100% { transform: translateX(-50%) rotate(360deg); }
        }
        
        .spotlight {
            position: absolute;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.3), transparent);
            animation: spotlightMove 6s ease-in-out infinite;
            pointer-events: none;
        }
        
        @keyframes spotlightMove {
            0%, 100% { transform: translate(0, 0); }
            25% { transform: translate(300px, 200px); }
            50% { transform: translate(-200px, 400px); }
            75% { transform: translate(400px, -100px); }
        }
        
        .light {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            animation: discoFlash 2s ease-in-out infinite;
        }
        
        @keyframes discoFlash {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.5); }
        }
        
        .container {
            position: relative;
            z-index: 10;
            text-align: center;
            padding: 20px;
            height: 100vh;
            height: 100dvh; /* Dynamic viewport height for mobile */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            /* Mobile Safari safe area */
            padding-top: max(20px, env(safe-area-inset-top));
            padding-bottom: max(20px, env(safe-area-inset-bottom));
        }
        
        .header {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }
        
        .title {
            font-size: 2.5em;
            font-weight: 700;
            color: #ff6b6b;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            margin-bottom: 10px;
        }
        
        .score-board {
            display: flex;
            justify-content: space-around;
            font-size: 1.2em;
            color: #2d3436;
            font-weight: 600;
        }
        
        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        .dancer {
            font-size: 120px;
            margin: 20px;
            transition: all 0.3s ease;
            filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.8));
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            width: 150px;
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
        }
        
        .dancer::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255, 107, 107, 0.1), rgba(254, 202, 87, 0.1));
            border-radius: inherit;
            pointer-events: none;
        }
        
        .dancer.thumka {
            animation: thumkaShake 0.5s ease-in-out;
        }
        
        .dancer.bhangra {
            animation: bhangraMove 0.6s ease-in-out;
        }
        
        .dancer.handwave {
            animation: handWave 0.5s ease-in-out;
        }
        
        .dancer.headbob {
            animation: headBob 0.4s ease-in-out;
        }
        
        .dancer.dandiya {
            animation: dandiyaMove 0.7s ease-in-out;
        }
        
        @keyframes thumkaShake {
            0%, 100% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(-5deg) scale(1.1) translateX(-10px); }
            75% { transform: rotate(5deg) scale(1.1) translateX(10px); }
        }
        
        @keyframes bhangraMove {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-20px) rotate(10deg) scale(1.1); }
            50% { transform: translateY(0) rotate(-10deg) scale(1.2); }
            75% { transform: translateY(-15px) rotate(5deg) scale(1.1); }
        }
        
        @keyframes handWave {
            0%, 100% { transform: rotateZ(0deg) rotateY(0deg); }
            25% { transform: rotateZ(15deg) rotateY(20deg) scale(1.1); }
            50% { transform: rotateZ(-15deg) rotateY(-20deg) scale(1.2); }
            75% { transform: rotateZ(10deg) rotateY(15deg) scale(1.1); }
        }
        
        @keyframes headBob {
            0%, 100% { transform: translateY(0) rotateX(0deg); }
            33% { transform: translateY(-10px) rotateX(10deg) scale(1.05); }
            66% { transform: translateY(5px) rotateX(-5deg) scale(1.1); }
        }
        
        @keyframes dandiyaMove {
            0%, 100% { transform: rotate(0deg) scale(1); }
            20% { transform: rotate(45deg) translateX(15px) scale(1.1); }
            40% { transform: rotate(-45deg) translateX(-15px) scale(1.2); }
            60% { transform: rotate(30deg) translateY(-10px) scale(1.15); }
            80% { transform: rotate(-30deg) translateY(10px) scale(1.1); }
        }
        
        .tap-cue {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2em;
            font-weight: 700;
            background: radial-gradient(circle, #ff6b6b, #feca57);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            opacity: 0;
            animation: tapCueFlash 0.5s ease-in-out;
            pointer-events: none;
        }
        
        @keyframes tapCueFlash {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
        }
        
        .feedback {
            font-size: 2em;
            font-weight: 700;
            margin: 20px 0;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .combo-meter {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 15px;
            font-weight: 700;
            font-size: 1.2em;
            color: #ff6b6b;
            display: none;
        }
        
        .combo-animation {
            animation: comboFlash 0.5s ease-in-out;
        }
        
        @keyframes comboFlash {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); color: #00b894; }
        }
        
        .power-up {
            position: absolute;
            font-size: 2em;
            background: radial-gradient(circle, #feca57, #ff6b6b);
            padding: 10px;
            border-radius: 50%;
            animation: powerUpFloat 2s ease-in-out infinite;
            cursor: pointer;
        }
        
        @keyframes powerUpFloat {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-10px) scale(1.1); }
        }
        
        .leaderboard {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            display: none;
            min-width: 300px;
        }
        
        .leaderboard h3 {
            color: #ff6b6b;
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        
        .score-entry {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 5px;
            border-radius: 5px;
            background: rgba(255, 107, 107, 0.1);
        }
        
        .difficulty-selector {
            margin: 15px 0;
        }
        
        .difficulty-btn {
            background: linear-gradient(45deg, #6c5ce7, #a29bfe);
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 20px;
            cursor: pointer;
            font-family: 'Dancing Script', cursive;
            font-weight: 600;
        }
        
        .difficulty-btn.active {
            background: linear-gradient(45deg, #00b894, #55a3ff);
            transform: scale(1.05);
        }
        
        .perfect { color: #00b894; text-shadow: 2px 2px 4px rgba(0, 184, 148, 0.5); }
        .good { color: #fdcb6e; text-shadow: 2px 2px 4px rgba(253, 203, 110, 0.5); }
        .missed { color: #e17055; text-shadow: 2px 2px 4px rgba(225, 112, 85, 0.5); }
        
        .controls {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .tap-button {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            border: none;
            border-radius: 50%;
            width: 120px;
            height: 120px;
            font-size: 2em;
            color: white;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            font-family: 'Dancing Script', cursive;
        }
        
        .tap-button:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.4);
        }
        
        .tap-button:active {
            transform: scale(0.95);
        }
        
        .start-button {
            background: linear-gradient(45deg, #00b894, #55a3ff);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 1.5em;
            font-weight: 600;
            cursor: pointer;
            margin: 10px;
            transition: all 0.2s ease;
            font-family: 'Dancing Script', cursive;
        }
        
        .start-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        
        .confetti {
            position: absolute;
            pointer-events: none;
            z-index: 100;
        }
        
        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #ff6b6b;
            animation: confettiFall 2s ease-out forwards;
        }
        
        @keyframes confettiFall {
            0% {
                opacity: 1;
                transform: translateY(0) rotate(0deg);
            }
            100% {
                opacity: 0;
                transform: translateY(300px) rotate(360deg);
            }
        }
        
        .celebration {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 30px;
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            text-align: center;
            font-size: 2em;
            color: #ff6b6b;
            display: none;
        }
        
        .game-status {
            font-size: 1.2em;
            color: #2d3436;
            margin: 10px 0;
            font-weight: 600;
        }
        
        @media (max-width: 768px) {
            .title { font-size: 2em; }
            .dancer { font-size: 80px; width: 120px; height: 120px; }
            .tap-button { width: 100px; height: 100px; font-size: 1.5em; }
            .score-board { font-size: 1em; }
            .feedback { font-size: 1.5em; }
            
            /* Mobile Safari specific fixes */
            .container {
                height: 100dvh; /* Dynamic viewport height */
                padding-bottom: max(20px, env(safe-area-inset-bottom) + 20px);
            }
            
            .controls {
                padding: 15px;
                margin-bottom: env(safe-area-inset-bottom);
            }
            
            /* Ensure controls are always visible above Safari bottom bar */
            .controls {
                position: relative;
                z-index: 100;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-radius: 20px 20px 0 0;
                box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.3);
            }
            
            /* Better touch targets for mobile */
            .tap-button, .start-button, .difficulty-btn {
                min-height: 44px; /* iOS recommended touch target */
                min-width: 44px;
            }
        }
        
        .audio-control {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5em;
            cursor: pointer;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div class="disco-lights" id="discoLights"></div>
    <div class="disco-ball"></div>
    <div class="spotlight"></div>
    
    <div class="combo-meter" id="comboMeter">
        Combo: <span id="combo">0</span>x
    </div>
    
    <div class="container">
        <div class="header">
            <div class="title">� Bollywood Beat Master �</div>
            <div class="score-board">
                <div>Score: <span id="score">0</span></div>
                <div>Round: <span id="round">0</span>/<span id="maxRounds">10</span></div>
                <div>Best: <span id="bestTime">0</span>ms</div>
            </div>
        </div>
        
        <div class="game-area">
            <div class="dancer" id="dancer">🎯</div>
            <div class="tap-cue" id="tapCue">💥 TAP NOW 💥</div>
            <div class="feedback" id="feedback"></div>
            <div class="game-status" id="gameStatus">Choose difficulty to start your rhythm gaming adventure!</div>
        </div>
        
        <div class="controls">
            <div class="difficulty-selector" id="difficultySelector">
                <button class="difficulty-btn active" onclick="selectDifficulty('easy')">� Novice</button>
                <button class="difficulty-btn" onclick="selectDifficulty('normal')">🔥 Pro</button>
                <button class="difficulty-btn" onclick="selectDifficulty('hard')">⚡ Elite</button>
                <button class="difficulty-btn" onclick="selectDifficulty('endless')">💎 Legend</button>
            </div>
            <button class="start-button" id="startButton" onclick="startGame()">🎬 Start Game</button>
            <button class="tap-button" id="tapButton" onclick="handleTap()" disabled>TAP!</button>
            <button class="start-button" onclick="showLeaderboard()" style="font-size: 1em; padding: 10px 20px;">🏆 Scores</button>
        </div>
    </div>
    
    <div class="celebration" id="celebration">
        <div id="celebrationTitle">🎉 You're a Rhythm Master! 🎉</div>
        <div style="font-size: 0.6em; margin-top: 20px;">
            Final Score: <span id="finalScore">0</span><br>
            Perfect Hits: <span id="perfectHits">0</span><br>
            Max Combo: <span id="maxComboDisplay">0</span>x
        </div>
        <div style="margin-top: 20px;">
            <input type="text" id="playerName" placeholder="Enter your name" maxlength="10" style="padding: 10px; border-radius: 10px; border: 2px solid #ff6b6b; margin-right: 10px;">
            <button class="start-button" onclick="saveScore()">💾 Save Score</button>
        </div>
        <button class="start-button" onclick="resetGame()" style="margin-top: 10px;">🔄 Play Again</button>
    </div>
    
    <div class="leaderboard" id="leaderboard">
        <h3>🏆 Gaming Champions 🏆</h3>
        <div id="leaderboardList"></div>
        <button class="start-button" onclick="hideLeaderboard()" style="margin-top: 15px;">✖️ Close</button>
    </div>
    
    <button class="audio-control" id="audioControl" onclick="toggleAudio()">🎵</button>
    
    <!-- Realistic Bollywood Music Tracks -->
    <audio id="bgMusic1" loop preload="auto">
        <!-- Classic Bollywood Instrumental -->
        <source src="https://actions.google.com/sounds/v1/musical_moments/tabla_beat_single.ogg" type="audio/ogg">
        <source src="https://actions.google.com/sounds/v1/musical_moments/tabla_beat_single.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="bgMusic2" loop preload="auto">
        <!-- Punjabi Dhol Beat -->
        <source src="https://actions.google.com/sounds/v1/musical_moments/dhol_beat_single.ogg" type="audio/ogg">
        <source src="https://actions.google.com/sounds/v1/musical_moments/dhol_beat_single.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="bgMusic3" loop preload="auto">
        <!-- Classical Indian Music -->
        <source src="https://actions.google.com/sounds/v1/musical_moments/sitar_strum_single.ogg" type="audio/ogg">
        <source src="https://actions.google.com/sounds/v1/musical_moments/sitar_strum_single.mp3" type="audio/mpeg">
    </audio>
    
    <!-- Additional Bollywood Music Tracks -->
    <audio id="bgMusic4" loop preload="auto">
        <!-- Folk Music Beat -->
        <source src="https://actions.google.com/sounds/v1/musical_moments/hand_clap_beat.ogg" type="audio/ogg">
        <source src="https://actions.google.com/sounds/v1/musical_moments/hand_clap_beat.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="bgMusic5" loop preload="auto">
        <!-- Modern Bollywood Fusion -->
        <source src="https://actions.google.com/sounds/v1/musical_moments/wood_block_beat.ogg" type="audio/ogg">
        <source src="https://actions.google.com/sounds/v1/musical_moments/wood_block_beat.mp3" type="audio/mpeg">
    </audio>
    
    <!-- Realistic Bollywood Sound Effects -->
    <audio id="perfectSound" preload="auto">
        <source src="https://actions.google.com/sounds/v1/impacts/bells_small_chimes.ogg" type="audio/ogg">
        <source src="https://actions.google.com/sounds/v1/impacts/bells_small_chimes.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="goodSound" preload="auto">
        <source src="https://actions.google.com/sounds/v1/musical_moments/tabla_beat_single.ogg" type="audio/ogg">
        <source src="https://actions.google.com/sounds/v1/musical_moments/tabla_beat_single.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="missSound" preload="auto">
        <source src="https://actions.google.com/sounds/v1/impacts/wood_plank_hit.ogg" type="audio/ogg">
        <source src="https://actions.google.com/sounds/v1/impacts/wood_plank_hit.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="comboSound" preload="auto">
        <source src="https://actions.google.com/sounds/v1/musical_moments/hand_clap_beat.ogg" type="audio/ogg">
        <source src="https://actions.google.com/sounds/v1/musical_moments/hand_clap_beat.mp3" type="audio/mpeg">
    </audio>
    
    <!-- Additional Bollywood Sound Effects -->
    <audio id="thumkaSound" preload="auto">
        <source src="https://actions.google.com/sounds/v1/musical_moments/dhol_beat_single.ogg" type="audio/ogg">
        <source src="https://actions.google.com/sounds/v1/musical_moments/dhol_beat_single.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="bhangraSound" preload="auto">
        <source src="https://actions.google.com/sounds/v1/musical_moments/wood_block_beat.ogg" type="audio/ogg">
        <source src="https://actions.google.com/sounds/v1/musical_moments/wood_block_beat.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="celebrationSound" preload="auto">
        <source src="https://actions.google.com/sounds/v1/impacts/celebration_cheer.ogg" type="audio/ogg">
        <source src="https://actions.google.com/sounds/v1/impacts/celebration_cheer.mp3" type="audio/mpeg">
    </audio>
    
    <script>
        // Enhanced Game State with all new features
        let gameState = {
            isPlaying: false,
            score: 0,
            round: 0,
            maxRounds: 10,
            bestTime: Infinity,
            thumkaStartTime: 0,
            waitingForTap: false,
            combo: 0,
            maxCombo: 0,
            perfectHits: 0,
            currentTheme: 0,
            difficulty: 'easy',
            powerUps: [],
            activePowerUp: null,
            currentMusic: 0,
            
            // Enhanced dancers with gaming-focused designs and professional appeal
            dancers: [
                { 
                    emoji: '🎯', 
                    name: 'Precision Dancer', 
                    image: 'https://images.unsplash.com/photo-1598300042247-d088f8ab3a91?w=150&h=150&fit=crop&crop=center',
                    silhouette: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImciIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNmZjZiNmI7c3RvcC1vcGFjaXR5OjEiIC8+PHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojZmVjYTU3O3N0b3Atb3BhY2l0eToxIiAvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxwYXRoIGQ9Ik03NSAyMEM4NSAyMCA5MCAzMCA4OCA0MEM4NSA1MCA4MCA1NSA3NSA1NUM3MCA1NSA2NSA1MCA2MiA0MEM2MCAzMCA2NSAyMCA3NSAyMFogTTc1IDU1Qzc4IDYwIDgyIDcwIDgwIDgwQzc3IDkwIDc1IDk1IDcwIDk1QzY1IDk1IDYwIDkwIDU3IDgwQzU1IDcwIDU5IDYwIDYyIDU1SDc1WiBNNjIgNTVDNDcgNjAgNDIgNzAgNDcgODBDNTIgOTAgNTcgOTUgNjIgOTVIODhDNTcgOTUgOTMgOTAgOTggODBDMTAzIDcwIDk4IDYwIDgzIDU1SDYyWiIgZmlsbD0idXJsKCNnKSIvPjwvc3ZnPg==',
                    sound: 'https://actions.google.com/sounds/v1/musical_moments/tabla_beat_single.mp3'
                },
                { 
                    emoji: '⚡', 
                    name: 'Lightning Performer', 
                    image: 'https://images.unsplash.com/photo-1594736797933-d0401ba2fe65?w=150&h=150&fit=crop&crop=center',
                    silhouette: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImgiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiM0OGRiZmI7c3RvcC1vcGFjaXR5OjEiIC8+PHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojZmY5ZmYzO3N0b3Atb3BhY2l0eToxIiAvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxwYXRoIGQ9Ik03NSAyNUM4MyAyNSA4NyAzMyA4NSA0MUM4MyA0OSA3OSA1MyA3NSA1M0M3MSA1MyA2NyA0OSA2NSA0MUM2MyAzMyA2NyAyNSA3NSAyNVogTTc1IDUzQzc5IDU3IDgzIDY1IDgxIDczQzc5IDgxIDc1IDg1IDcxIDg1QzY3IDg1IDYzIDgxIDYxIDczQzU5IDY1IDYzIDU3IDY3IDUzSDc1WiBNNjcgNTNDNTMgNTcgNDkgNjUgNTMgNzNDNTcgODEgNjEgODUgNjcgODVIODNDNjEgODUgODkgODEgOTMgNzNDOTcgNjUgOTMgNTcgNzkgNTNINjdaIiBmaWxsPSJ1cmwoI2gpIi8+PC9zdmc+',
                    sound: 'https://actions.google.com/sounds/v1/musical_moments/dhol_beat_single.mp3'
                },
                { 
                    emoji: '🏆', 
                    name: 'Champion Duo', 
                    image: 'https://images.unsplash.com/photo-1574391884720-bbc7b2f075e3?w=150&h=150&fit=crop&crop=center',
                    silhouette: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImkiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiM1NGEwZmY7c3RvcC1vcGFjaXR5OjEiIC8+PHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojZmZkZDAwO3N0b3Atb3BhY2l0eToxIiAvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxwYXRoIGQ9Ik00NSAyNUM1MSAyNSA1MyAzMSA1MiAzN0M1MSA0MyA0OSA0NSA0NSA0NUM0MSA0NSAzOSA0MyAzOCAzN0MzNyAzMSAzOSAyNSA0NSAyNVogTTEwNSAyNUMxMTEgMjUgMTEzIDMxIDExMiAzN0MxMTEgNDMgMTA5IDQ1IDEwNSA0NUMxMDEgNDUgOTkgNDMgOTggMzdDOTcgMzEgOTkgMjUgMTA1IDI1WiBNNDUgNDVDNDggNDcgNTEgNTMgNTAgNTlDNDkgNjUgNDUgNjcgNDEgNjdDMzcgNjcgMzMgNjUgMzIgNTlDMzEgNTMgMzQgNDcgMzcgNDVINDVaIE0xMDUgNDVDMTA4IDQ3IDExMSA1MyAxMTAgNTlDMTA5IDY1IDEwNSA2NyAxMDEgNjdDOTcgNjcgOTMgNjUgOTIgNTlDOTEgNTMgOTQgNDcgOTcgNDVIMTA1WiIgZmlsbD0idXJsKCNpKSIvPjwvc3ZnPg==',
                    sound: 'https://actions.google.com/sounds/v1/musical_moments/hand_clap_beat.mp3'
                },
                { 
                    emoji: '💎', 
                    name: 'Elite Master', 
                    image: 'https://images.unsplash.com/photo-1583308872811-73283d4c5a20?w=150&h=150&fit=crop&crop=center',
                    silhouette: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImoiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNkNjNlMzE7c3RvcC1vcGFjaXR5OjEiIC8+PHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojZmZkNzAwO3N0b3Atb3BhY2l0eToxIiAvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxwYXRoIGQ9Ik03NSAyMkM4NSAyMiA5MCAzMiA4OCA0MkM4NSA1MiA4MCA1NyA3NSA1N0M3MCA1NyA2NSA1MiA2MiA0MkM2MCAzMiA2NSAyMiA3NSAyMlpNNzUgNTdDODAgNjAgODUgNzAgODMgODBDODAgOTAgNzUgOTUgNzAgOTVDNjUgOTUgNjAgOTAgNTcgODBDNTUgNzAgNjAgNjAgNjUgNTdINzVaIiBmaWxsPSJ1cmwoI2opIi8+PC9zdmc+',
                    sound: 'https://actions.google.com/sounds/v1/impacts/bells_small_chimes.mp3'
                },
                { 
                    emoji: '🎮', 
                    name: 'Pro Gamer', 
                    image: 'https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=150&h=150&fit=crop&crop=center',
                    silhouette: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImsiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNmNzk3Zjg7c3RvcC1vcGFjaXR5OjEiIC8+PHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojZmZkNzAwO3N0b3Atb3BhY2l0eToxIiAvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxwYXRoIGQ9Ik03NSAyNUM4MyAyNSA4NyAzMyA4NSA0MUM4MyA0OSA3OSA1MyA3NSA1M0M3MSA1MyA2NyA0OSA2NSA0MUM2MyAzMyA2NyAyNSA3NSAyNVoiIGZpbGw9InVybCgjaylbMjM0Jyk+PC9wYXRoPjwvc3ZnPg==',
                    sound: 'https://actions.google.com/sounds/v1/musical_moments/wood_block_beat.mp3'
                }
            ],
            currentDancer: 0,
            
            // Gaming-focused dance moves with professional appeal
            danceMoves: [
                { name: 'Power Strike', emoji: '🎯', cue: 'PRECISION STRIKE!', animation: 'thumka', difficulty: 1, sound: 'thumkaSound', description: 'Perfect timing challenge' },
                { name: 'Lightning Combo', emoji: '⚡', cue: 'LIGHTNING FAST!', animation: 'bhangra', difficulty: 2, sound: 'bhangraSound', description: 'Speed combo move' },
                { name: 'Victory Wave', emoji: '🏆', cue: 'CHAMPION MOVE!', animation: 'handwave', difficulty: 1.5, sound: 'perfectSound', description: 'Triumphant gesture' },
                { name: 'Beat Drop', emoji: '🔥', cue: 'DROP THE BEAT!', animation: 'headbob', difficulty: 1.2, sound: 'goodSound', description: 'Rhythm mastery' },
                { name: 'Epic Spin', emoji: '💫', cue: 'EPIC COMBO!', animation: 'dandiya', difficulty: 2.5, sound: 'comboSound', description: 'Advanced rotation' },
                { name: 'Power Burst', emoji: '💥', cue: 'POWER BURST!', animation: 'thumka', difficulty: 2.2, sound: 'thumkaSound', description: 'Explosive movement' },
                { name: 'Master Flow', emoji: '💎', cue: 'MASTER LEVEL!', animation: 'handwave', difficulty: 1.8, sound: 'celebrationSound', description: 'Elite technique' }
            ],
            currentMove: 0,
            
            // Background themes
            themes: ['theme-holi', 'theme-diwali', 'theme-wedding', 'theme-club'],
            
            // Voice clips for feedback - Gaming with Bollywood flair
            voiceClips: [
                'Epic Win! Legendary!', 'Perfect Strike! Pro Level!', 'Outstanding! You\'re Fire!', 
                'Insane Combo! Beast Mode!', 'Flawless Victory!', 'Champion Performance!',
                'Godlike Skills!', 'Unstoppable Force!', 'Elite Gamer!',
                'Maximum Power!', 'Victory Royale!', 'Crushing It!'
            ]
        };
        
        let gameInterval;
        let audioEnabled = true;
        let currentBGMusic = null;
        
        // Difficulty settings
        const difficultySettings = {
            easy: { rounds: 10, minDelay: 3000, maxDelay: 5000, perfectWindow: 150, goodWindow: 300 },
            normal: { rounds: 15, minDelay: 2000, maxDelay: 4000, perfectWindow: 120, goodWindow: 250 },
            hard: { rounds: 20, minDelay: 1500, maxDelay: 3000, perfectWindow: 100, goodWindow: 200 },
            endless: { rounds: Infinity, minDelay: 1000, maxDelay: 2500, perfectWindow: 80, goodWindow: 180 }
        };
        
        // Initialize enhanced disco lights with realistic effects
        function createDiscoLights() {
            const discoContainer = document.getElementById('discoLights');
            const colors = ['#ff6b6b', '#feca57', '#48dbfb', '#ff9ff3', '#54a0ff', '#fd79a8', '#00b894'];
            
            // Create more disco lights
            for (let i = 0; i < 30; i++) {
                const light = document.createElement('div');
                light.className = 'light';
                light.style.left = Math.random() * 100 + '%';
                light.style.top = Math.random() * 100 + '%';
                light.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                light.style.animationDelay = Math.random() * 2 + 's';
                light.style.width = (Math.random() * 15 + 10) + 'px';
                light.style.height = light.style.width;
                discoContainer.appendChild(light);
            }
            
            // Add moving spotlights
            for (let i = 0; i < 3; i++) {
                const spotlight = document.createElement('div');
                spotlight.className = 'spotlight';
                spotlight.style.animationDelay = i * 2 + 's';
                spotlight.style.animationDuration = (6 + i * 2) + 's';
                discoContainer.appendChild(spotlight);
            }
        }
        
        // Enhanced theme switching
        function switchTheme() {
            gameState.currentTheme = (gameState.currentTheme + 1) % gameState.themes.length;
            document.body.className = gameState.themes[gameState.currentTheme];
        }
        
        // Power-up system
        function createPowerUp() {
            if (Math.random() < 0.15 && gameState.isPlaying) { // 15% chance
                const powerUp = document.createElement('div');
                powerUp.className = 'power-up';
                powerUp.innerHTML = ['⚡', '🔥', '⭐', '💎'][Math.floor(Math.random() * 4)];
                powerUp.style.left = Math.random() * 80 + 10 + '%';
                powerUp.style.top = Math.random() * 60 + 20 + '%';
                
                const powerType = ['double', 'slow', 'perfect', 'combo'][Math.floor(Math.random() * 4)];
                powerUp.dataset.type = powerType;
                
                powerUp.onclick = () => activatePowerUp(powerType, powerUp);
                
                document.querySelector('.game-area').appendChild(powerUp);
                
                // Remove after 5 seconds if not clicked
                setTimeout(() => {
                    if (powerUp.parentNode) {
                        powerUp.remove();
                    }
                }, 5000);
            }
        }
        
        function activatePowerUp(type, element) {
            gameState.activePowerUp = { type, duration: 3000, startTime: Date.now() };
            element.remove();
            
            // Visual feedback
            showFeedback(`Power-Up: ${type.toUpperCase()}!`, 'perfect');
            playSound('comboSound');
        }
        
        // Enhanced display with combo meter
        function updateDisplay() {
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('round').textContent = gameState.round;
            document.getElementById('maxRounds').textContent = 
                gameState.difficulty === 'endless' ? '∞' : difficultySettings[gameState.difficulty].rounds;
            document.getElementById('bestTime').textContent = 
                gameState.bestTime === Infinity ? '0' : Math.round(gameState.bestTime);
            
            // Update combo meter
            const comboMeter = document.getElementById('comboMeter');
            const comboDisplay = document.getElementById('combo');
            if (gameState.combo > 1) {
                comboMeter.style.display = 'block';
                comboDisplay.textContent = gameState.combo;
                if (gameState.combo > gameState.maxCombo) {
                    gameState.maxCombo = gameState.combo;
                    comboMeter.classList.add('combo-animation');
                    setTimeout(() => comboMeter.classList.remove('combo-animation'), 500);
                }
            } else {
                comboMeter.style.display = 'none';
            }
        }
        
        // Difficulty selection
        function selectDifficulty(difficulty) {
            gameState.difficulty = difficulty;
            
            // Update UI
            document.querySelectorAll('.difficulty-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('gameStatus').textContent = 
                `${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)} mode selected! Press Start to begin!`;
        }
        
        // Enhanced music system with authentic Bollywood tracks
        function playBackgroundMusic() {
            if (!audioEnabled) return;
            
            if (currentBGMusic) {
                currentBGMusic.pause();
            }
            
            const musicTracks = ['bgMusic1', 'bgMusic2', 'bgMusic3', 'bgMusic4', 'bgMusic5'];
            gameState.currentMusic = (gameState.currentMusic + 1) % musicTracks.length;
            currentBGMusic = document.getElementById(musicTracks[gameState.currentMusic]);
            
            // Set volume for better experience
            currentBGMusic.volume = 0.4; // Reduced volume for better mobile experience
            currentBGMusic.play().catch(e => {
                console.log('Audio play failed:', e);
                // Try to enable audio on next user interaction
                document.addEventListener('click', enableAudioOnTouch, { once: true });
                document.addEventListener('touchstart', enableAudioOnTouch, { once: true });
            });
        }
        
        // Enable audio on first user interaction (required for mobile)
        function enableAudioOnTouch() {
            if (currentBGMusic && audioEnabled) {
                currentBGMusic.play().catch(e => console.log('Touch audio enable failed:', e));
            }
        }
        
        function playSound(soundId) {
            if (!audioEnabled) return;
            const sound = document.getElementById(soundId);
            if (sound) {
                sound.currentTime = 0;
                sound.volume = 0.7;
                sound.play().catch(e => console.log('Sound play failed:', e));
            }
        }
        
        // Enhanced sound for specific dance moves
        function playDanceMoveSound(moveIndex) {
            if (!audioEnabled) return;
            
            const move = gameState.danceMoves[moveIndex];
            if (move.sound) {
                playSound(move.sound);
            }
            
            // Additional sound effects based on move type
            setTimeout(() => {
                if (move.name === 'Thumka' || move.name === 'Jhatkas') {
                    playSound('thumkaSound');
                } else if (move.name === 'Bhangra') {
                    playSound('bhangraSound');
                } else if (move.name === 'Dandiya') {
                    playSound('comboSound');
                }
            }, 200);
        }
        
        // Voice feedback system with enhanced gaming expressions
        function playVoiceClip(type) {
            if (!audioEnabled) return;
            
            let clips;
            switch(type) {
                case 'perfect':
                    clips = ['Epic Win! Legendary!', 'Perfect Strike! Pro Level!', 'Godlike Skills!', 'Flawless Victory!'];
                    break;
                case 'good':
                    clips = ['Outstanding! You\'re Fire!', 'Champion Performance!', 'Elite Gamer!'];
                    break;
                case 'miss':
                    clips = ['Keep Grinding!', 'Almost There!', 'Next Round!'];
                    break;
                case 'combo':
                    clips = ['Insane Combo! Beast Mode!', 'Maximum Power!', 'Unstoppable Force!', 'Victory Royale!'];
                    break;
                default:
                    clips = gameState.voiceClips;
            }
            
            const clip = clips[Math.floor(Math.random() * clips.length)];
            
            // Create a speech synthesis for Bollywood phrases
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(clip);
                utterance.rate = 1.2;
                utterance.pitch = 1.3;
                utterance.volume = 0.7;
                utterance.lang = 'en-IN'; // Indian English accent
                speechSynthesis.speak(utterance);
            }
            
            // Also play celebration sound for perfect hits
            if (type === 'perfect') {
                setTimeout(() => playSound('celebrationSound'), 500);
            }
        }
        
        function startGame() {
            gameState.isPlaying = true;
            gameState.score = 0;
            gameState.round = 0;
            gameState.combo = 0;
            gameState.maxCombo = 0;
            gameState.perfectHits = 0;
            gameState.bestTime = Infinity;
            gameState.maxRounds = difficultySettings[gameState.difficulty].rounds;
            
            document.getElementById('startButton').style.display = 'none';
            document.getElementById('difficultySelector').style.display = 'none';
            document.getElementById('tapButton').disabled = false;
            document.getElementById('gameStatus').textContent = 'Get ready for the first move!';
            document.getElementById('feedback').textContent = '';
            
            playBackgroundMusic();
            updateDisplay();
            
            // Change theme every few rounds
            switchTheme();
            
            scheduleNextMove();
        }
        
        function scheduleNextMove() {
            if (gameState.round >= gameState.maxRounds) {
                endGame();
                return;
            }
            
            const settings = difficultySettings[gameState.difficulty];
            const delay = Math.random() * (settings.maxDelay - settings.minDelay) + settings.minDelay;
            
            setTimeout(() => {
                if (gameState.isPlaying) {
                    performDanceMove();
                }
            }, delay);
        }
        
        function performDanceMove() {
            gameState.round++;
            gameState.waitingForTap = true;
            gameState.thumkaStartTime = Date.now();
            
            // Select random dance move
            gameState.currentMove = Math.floor(Math.random() * gameState.danceMoves.length);
            const move = gameState.danceMoves[gameState.currentMove];
            
            // Change dancer occasionally with realistic images
            if (Math.random() < 0.4) {
                gameState.currentDancer = (gameState.currentDancer + 1) % gameState.dancers.length;
                const dancer = document.getElementById('dancer');
                const currentDancerData = gameState.dancers[gameState.currentDancer];
                
                // Use real images 60% of the time, silhouettes 30%, emojis 10%
                const displayChoice = Math.random();
                if (displayChoice < 0.6 && currentDancerData.image) {
                    // Use realistic Bollywood dancer image
                    dancer.style.backgroundImage = `url(${currentDancerData.image})`;
                    dancer.style.backgroundSize = 'cover';
                    dancer.style.backgroundPosition = 'center';
                    dancer.style.borderRadius = '50%';
                    dancer.style.border = '4px solid #ff6b6b';
                    dancer.textContent = '';
                } else if (displayChoice < 0.9) {
                    // Use artistic silhouette
                    dancer.style.backgroundImage = `url(${currentDancerData.silhouette})`;
                    dancer.style.backgroundSize = 'contain';
                    dancer.style.borderRadius = '20px';
                    dancer.style.border = '2px solid #feca57';
                    dancer.textContent = '';
                } else {
                    // Use emoji
                    dancer.style.backgroundImage = '';
                    dancer.style.border = 'none';
                    dancer.style.borderRadius = '0';
                    dancer.textContent = currentDancerData.emoji;
                }
                
                // Play dancer-specific sound
                if (currentDancerData.sound) {
                    setTimeout(() => playSound('perfectSound'), 100);
                }
            }
            
            // Animate dancer with specific move
            const dancer = document.getElementById('dancer');
            dancer.classList.add(move.animation);
            
            // Show move-specific cue with description
            const tapCue = document.getElementById('tapCue');
            tapCue.innerHTML = `${move.emoji} ${move.cue} ${move.emoji}`;
            tapCue.style.opacity = '1';
            tapCue.style.animation = 'tapCueFlash 0.5s ease-in-out';
            
            // Enhanced screen flash with color
            document.body.style.filter = 'brightness(1.4) saturate(1.3)';
            setTimeout(() => {
                document.body.style.filter = 'brightness(1) saturate(1)';
            }, 150);
            
            document.getElementById('gameStatus').textContent = 
                `Round ${gameState.round} - ${move.description}!`;
            
            // Play move-specific sound
            playDanceMoveSound(gameState.currentMove);
            
            // Create power-up occasionally
            createPowerUp();
            
            // Theme change every 5 rounds
            if (gameState.round % 5 === 0) {
                switchTheme();
            }
            
            // Auto-miss after adjusted time based on difficulty
            const missTimeout = gameState.difficulty === 'hard' ? 800 : 
                               gameState.difficulty === 'normal' ? 1000 : 1200;
            
            setTimeout(() => {
                if (gameState.waitingForTap) {
                    handleMiss();
                }
            }, missTimeout);
            
            // Remove animation
            setTimeout(() => {
                dancer.classList.remove(move.animation);
            }, 700);
        }
        
        function handleTap() {
            if (!gameState.isPlaying || !gameState.waitingForTap) {
                return;
            }
            
            const reactionTime = Date.now() - gameState.thumkaStartTime;
            gameState.waitingForTap = false;
            
            const settings = difficultySettings[gameState.difficulty];
            let feedback, className, points, isGoodHit = false;
            
            // Apply power-up effects
            let adjustedPerfectWindow = settings.perfectWindow;
            let adjustedGoodWindow = settings.goodWindow;
            let pointMultiplier = 1;
            
            if (gameState.activePowerUp) {
                const powerUp = gameState.activePowerUp;
                const elapsed = Date.now() - powerUp.startTime;
                
                if (elapsed < powerUp.duration) {
                    switch (powerUp.type) {
                        case 'slow':
                            adjustedPerfectWindow *= 1.5;
                            adjustedGoodWindow *= 1.5;
                            break;
                        case 'double':
                            pointMultiplier = 2;
                            break;
                        case 'perfect':
                            if (reactionTime <= adjustedGoodWindow) {
                                reactionTime = adjustedPerfectWindow - 1; // Force perfect
                            }
                            break;
                    }
                } else {
                    gameState.activePowerUp = null;
                }
            }
            
            if (reactionTime <= adjustedPerfectWindow) {
                feedback = '🔥 Perfect Strike!';
                className = 'perfect';
                points = 100;
                gameState.perfectHits++;
                gameState.combo++;
                isGoodHit = true;
                playSound('perfectSound');
                playVoiceClip('perfect');
                createEnhancedConfetti('perfect');
            } else if (reactionTime <= adjustedGoodWindow) {
                feedback = '🎯 Great Hit!';
                className = 'good';
                points = 50;
                gameState.combo++;
                isGoodHit = true;
                playSound('goodSound');
                playVoiceClip('good');
                createEnhancedConfetti('good');
            } else {
                feedback = '� Keep Trying!';
                className = 'missed';
                points = 10;
                gameState.combo = 0;
                playSound('missSound');
                playVoiceClip('miss');
            }
            
            // Apply combo bonus with Bollywood flair
            if (gameState.combo > 2) {
                const comboBonus = Math.floor(gameState.combo / 3) * 25;
                points += comboBonus;
                feedback += ` +${comboBonus} Combo Blast!`;
                
                if (gameState.combo % 5 === 0) {
                    playSound('comboSound');
                    playVoiceClip('combo');
                    feedback += ' 🔥 Fire Streak! 🔥';
                }
            }
            
            // Apply power-up multiplier
            points *= pointMultiplier;
            
            if (reactionTime < gameState.bestTime && isGoodHit) {
                gameState.bestTime = reactionTime;
            }
            
            gameState.score += points;
            
            showFeedback(`${feedback} (${reactionTime}ms)`, className);
            updateDisplay();
            
            // Schedule next move
            setTimeout(() => {
                document.getElementById('feedback').textContent = '';
                scheduleNextMove();
            }, 1500);
        }
        
        function showFeedback(text, className) {
            const feedbackElement = document.getElementById('feedback');
            feedbackElement.textContent = text;
            feedbackElement.className = 'feedback ' + className;
        }
        
        function handleMiss() {
            if (!gameState.waitingForTap) return;
            
            gameState.waitingForTap = false;
            gameState.combo = 0;
            
            showFeedback('� Missed! Try Again!', 'missed');
            playSound('missSound');
            playVoiceClip('miss');
            updateDisplay();
            
            setTimeout(() => {
                document.getElementById('feedback').textContent = '';
                scheduleNextMove();
            }, 1500);
        }
        
        // Enhanced confetti system
        function createEnhancedConfetti(type) {
            const colors = type === 'perfect' 
                ? ['#00b894', '#00cec9', '#55efc4', '#81ecec']
                : ['#fdcb6e', '#f39c12', '#e17055', '#fd79a8'];
            
            const particleCount = type === 'perfect' ? 30 : 20;
            
            for (let i = 0; i < particleCount; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti-piece';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                confetti.style.animationDuration = (1.5 + Math.random() * 0.5) + 's';
                
                // Add different shapes
                if (Math.random() < 0.3) {
                    confetti.style.borderRadius = '0';
                    confetti.innerHTML = ['⭐', '💫', '✨', '🎉'][Math.floor(Math.random() * 4)];
                    confetti.style.fontSize = '12px';
                    confetti.style.background = 'transparent';
                }
                
                document.body.appendChild(confetti);
                
                setTimeout(() => {
                    confetti.remove();
                }, 2000);
            }
        }
        
        // Leaderboard system with localStorage
        function saveScore() {
            const playerName = document.getElementById('playerName').value || 'Anonymous';
            const newScore = {
                name: playerName,
                score: gameState.score,
                perfectHits: gameState.perfectHits,
                maxCombo: gameState.maxCombo,
                difficulty: gameState.difficulty,
                date: new Date().toLocaleDateString()
            };
            
            let leaderboard = JSON.parse(localStorage.getItem('bollywoodLeaderboard') || '[]');
            leaderboard.push(newScore);
            leaderboard.sort((a, b) => b.score - a.score);
            leaderboard = leaderboard.slice(0, 10); // Keep top 10
            
            localStorage.setItem('bollywoodLeaderboard', JSON.stringify(leaderboard));
            
            document.getElementById('celebration').style.display = 'none';
            showLeaderboard();
        }
        
        function showLeaderboard() {
            const leaderboard = JSON.parse(localStorage.getItem('bollywoodLeaderboard') || '[]');
            const leaderboardList = document.getElementById('leaderboardList');
            
            if (leaderboard.length === 0) {
                leaderboardList.innerHTML = '<div style="text-align: center; color: #666;">No scores yet!</div>';
            } else {
                leaderboardList.innerHTML = leaderboard.map((score, index) => `
                    <div class="score-entry">
                        <span>${index + 1}. ${score.name}</span>
                        <span>${score.score} pts (${score.difficulty})</span>
                    </div>
                `).join('');
            }
            
            document.getElementById('leaderboard').style.display = 'block';
        }
        
        function hideLeaderboard() {
            document.getElementById('leaderboard').style.display = 'none';
        }
        
        function endGame() {
            gameState.isPlaying = false;
            document.getElementById('tapButton').disabled = true;
            document.getElementById('gameStatus').textContent = 'Game Complete!';
            
            // Stop music
            if (currentBGMusic) {
                currentBGMusic.pause();
            }
            
            // Update celebration text based on performance
            const celebrationTitle = document.getElementById('celebrationTitle');
            if (gameState.perfectHits >= gameState.round * 0.8) {
                celebrationTitle.textContent = '👑 Gaming Legend! 👑';
            } else if (gameState.perfectHits >= gameState.round * 0.6) {
                celebrationTitle.textContent = '� Rhythm Master! �';
            } else if (gameState.perfectHits >= gameState.round * 0.4) {
                celebrationTitle.textContent = '� Pro Player! �';
            } else {
                celebrationTitle.textContent = '� Keep Gaming! �';
            }
            
            // Show enhanced celebration
            document.getElementById('finalScore').textContent = gameState.score;
            document.getElementById('perfectHits').textContent = gameState.perfectHits;
            document.getElementById('maxComboDisplay').textContent = gameState.maxCombo;
            document.getElementById('celebration').style.display = 'block';
            
            // Create massive confetti explosion
            for (let i = 0; i < 100; i++) {
                setTimeout(() => createEnhancedConfetti(i % 2 === 0 ? 'perfect' : 'good'), i * 50);
            }
            
            // Play victory voice clip
            setTimeout(() => playVoiceClip('victory'), 1000);
        }
        
        function resetGame() {
            document.getElementById('celebration').style.display = 'none';
            document.getElementById('startButton').style.display = 'inline-block';
            document.getElementById('difficultySelector').style.display = 'block';
            document.getElementById('feedback').textContent = '';
            document.getElementById('gameStatus').textContent = 'Choose difficulty to begin your Bollywood adventure!';
            document.getElementById('comboMeter').style.display = 'none';
            
            // Clear power-ups
            document.querySelectorAll('.power-up').forEach(p => p.remove());
            
            gameState.isPlaying = false;
            gameState.score = 0;
            gameState.round = 0;
            gameState.combo = 0;
            gameState.maxCombo = 0;
            gameState.perfectHits = 0;
            gameState.bestTime = Infinity;
            gameState.activePowerUp = null;
            updateDisplay();
        }
        
        function toggleAudio() {
            audioEnabled = !audioEnabled;
            const audioControl = document.getElementById('audioControl');
            
            if (audioEnabled) {
                audioControl.textContent = '🎵';
                if (gameState.isPlaying && currentBGMusic) {
                    currentBGMusic.play().catch(e => console.log('Audio play failed:', e));
                }
            } else {
                audioControl.textContent = '🔇';
                if (currentBGMusic) {
                    currentBGMusic.pause();
                }
            }
        }
        
        // Enhanced touch and keyboard support
        document.getElementById('tapButton').addEventListener('touchstart', function(e) {
            e.preventDefault();
            handleTap();
        });
        
        // Multi-key support
        document.addEventListener('keydown', function(e) {
            if (e.code === 'Space' || e.code === 'Enter' || e.code === 'ArrowUp') {
                e.preventDefault();
                if (gameState.isPlaying) {
                    handleTap();
                } else if (!document.getElementById('celebration').style.display || 
                          document.getElementById('celebration').style.display === 'none') {
                    if (document.getElementById('startButton').style.display !== 'none') {
                        startGame();
                    }
                }
            }
            
            // Theme switching with T key
            if (e.code === 'KeyT' && gameState.isPlaying) {
                switchTheme();
            }
            
            // Music switching with M key
            if (e.code === 'KeyM' && gameState.isPlaying) {
                playBackgroundMusic();
            }
        });
        
        // Initialize the enhanced game with audio preloading
        function initializeGame() {
            createDiscoLights();
            updateDisplay();
            
            // Preload all audio files
            const audioElements = document.querySelectorAll('audio');
            let loadedCount = 0;
            
            audioElements.forEach(audio => {
                audio.addEventListener('canplaythrough', () => {
                    loadedCount++;
                    if (loadedCount === audioElements.length) {
                        document.getElementById('gameStatus').textContent = 
                            'Audio loaded! Choose difficulty to begin your Bollywood adventure!';
                    }
                });
                
                // Set volumes
                if (audio.id.includes('bgMusic')) {
                    audio.volume = 0.6;
                } else {
                    audio.volume = 0.7;
                }
            });
            
            // Initialize default difficulty
            selectDifficulty('easy');
        }
        
        // Photo mode functionality
        function takeScreenshot() {
            // This would require additional canvas implementation
            // For now, show a message
            showFeedback('📸 Photo saved to your memories! 📸', 'perfect');
        }
        
        // Add screenshot button to celebration
        function addPhotoButton() {
            const celebration = document.getElementById('celebration');
            if (celebration) {
                const photoBtn = document.createElement('button');
                photoBtn.className = 'start-button';
                photoBtn.innerHTML = '📸 Take Photo';
                photoBtn.onclick = takeScreenshot;
                photoBtn.style.fontSize = '1em';
                photoBtn.style.padding = '10px 20px';
                photoBtn.style.margin = '5px';
                celebration.appendChild(photoBtn);
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeGame();
            addPhotoButton();
            
            // Add mobile-specific event listeners
            document.addEventListener('touchstart', enableAudioOnTouch, { once: true });
            
            // Prevent zoom on double tap for better mobile experience
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function (event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
            
            // Add vibration feedback for mobile devices
            if ('vibrate' in navigator) {
                // Add haptic feedback to tap button
                const tapButton = document.getElementById('tapButton');
                const originalHandleTap = handleTap;
                
                // Override handleTap to include vibration
                window.handleTap = function() {
                    if (gameState.isPlaying && gameState.waitingForTap) {
                        navigator.vibrate(50); // Short vibration on tap
                    }
                    originalHandleTap();
                };
            }
        });
    </script>
</body>
</html>
